<ion-header class="custom-header">
  <ion-toolbar>
    
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/user" class="back-btn"></ion-back-button>
    </ion-buttons>

    <ion-title>Chat con IA</ion-title>

    <ion-buttons slot="end">
      <!-- Selector de idioma -->
      <ion-button (click)="languageSelector.open()" class="language-btn">
        <ion-icon name="language-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-select 
        #languageSelector 
        [(ngModel)]="language" 
        interface="popover" 
        label="Idioma"
        class="language-select">
        <ion-select-option value="es"> Espa帽ol</ion-select-option>
        <ion-select-option value="en"> English</ion-select-option>
      </ion-select>
    </ion-buttons>

  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ai-chat-content">
  <div class="chat-wrapper">

    <!-- Timeline de mensajes -->
    <div class="chat-container">

      <!-- Render de items del timeline: chips de fecha + mensajes -->
      <ng-container *ngFor="let item of timeline; let i = index">
        
        <!-- Chip de fecha -->
        <div *ngIf="item.type === 'date'"
             class="date-chip"
             role="separator"
             [attr.aria-label]="item.label">
          <span class="date-chip-line" aria-hidden="true"></span>
          <span class="date-chip-label">{{ item.label }}</span>
          <span class="date-chip-line" aria-hidden="true"></span>
        </div>

        <!-- Grupo de mensajes IA -->
        <div *ngIf="item.type === 'group' && !item.isUser" class="message-group ai-group">
          <ng-container *ngFor="let msg of item.messages; let j = index">
            <div class="message-wrapper ai-wrapper"
                 [class.group-start]="msg.groupStart"
                 [class.group-end]="msg.groupEnd"
                 [class.error-message]="msg.error">

              <!-- Avatar IA -->
              <div class="message-avatar ai-avatar" *ngIf="msg.groupStart">
                <ion-icon name="sparkles"></ion-icon>
              </div>

              <!-- Burbuja de mensaje -->
              <div class="message-bubble ai-bubble">
                <!-- Nombre del remitente -->
                <p class="sender-name" *ngIf="msg.groupStart">
                  <ion-icon name="sparkles-outline"></ion-icon>
                  Asistente Virtual
                </p>

                <!-- Texto normal -->
                <div class="message-text" *ngIf="!msg.format || msg.format === 'text'">
                  {{ msg.text }}
                </div>

                <!-- Bloque de c贸digo -->
                <div class="code-block" *ngIf="msg.format === 'code'">
                  <div class="code-header">
                    <span class="code-label">
                      <ion-icon name="code-slash-outline"></ion-icon>
                      C贸digo
                    </span>
                    <ion-button 
                      fill="clear" 
                      size="small" 
                      class="copy-btn"
                      (click)="copyCode(msg.text)"
                      aria-label="Copiar c贸digo">
                      <ion-icon name="copy-outline" slot="start"></ion-icon>
                      Copiar
                    </ion-button>
                  </div>
                  <pre><code>{{ msg.text }}</code></pre>
                </div>

                <!-- Chips de fuentes -->
                <div class="sources" *ngIf="msg.sources?.length">
                  <ion-chip 
                    class="source-chip" 
                    *ngFor="let s of msg.sources" 
                    (click)="openSource(s.url)">
                    <ion-icon name="link-outline"></ion-icon>
                    <ion-label>{{ s.label || 'Fuente' }}</ion-label>
                  </ion-chip>
                </div>

                <div class="message-footer">
                  <span class="message-time">{{ msg.timestamp | date:'shortTime' }}</span>
                </div>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- Grupo de mensajes Usuario -->
        <div *ngIf="item.type === 'group' && item.isUser" class="message-group user-group">
          <ng-container *ngFor="let msg of item.messages; let j = index">
            <div class="message-wrapper user-wrapper"
                 [class.group-start]="msg.groupStart"
                 [class.group-end]="msg.groupEnd"
                 [class.error-message]="msg.error">

              <!-- Burbuja de mensaje -->
              <div class="message-bubble user-bubble">
                <!-- Texto normal -->
                <div class="message-text" *ngIf="!msg.format || msg.format === 'text'">
                  {{ msg.text }}
                </div>

                <!-- Bloque de c贸digo -->
                <div class="code-block" *ngIf="msg.format === 'code'">
                  <div class="code-header">
                    <span class="code-label">
                      <ion-icon name="code-slash-outline"></ion-icon>
                      C贸digo
                    </span>
                    <ion-button 
                      fill="clear" 
                      size="small" 
                      class="copy-btn"
                      (click)="copyCode(msg.text)"
                      aria-label="Copiar c贸digo">
                      <ion-icon name="copy-outline" slot="start"></ion-icon>
                      Copiar
                    </ion-button>
                  </div>
                  <pre><code>{{ msg.text }}</code></pre>
                </div>

                <div class="message-footer">
                  <span class="message-time">{{ msg.timestamp | date:'shortTime' }}</span>
                </div>
              </div>

              <!-- Avatar Usuario -->
              <div class="message-avatar user-avatar" *ngIf="msg.groupEnd">
                <ion-icon name="person"></ion-icon>
              </div>
            </div>
          </ng-container>
        </div>
      </ng-container>

      <!-- Indicador escribiendo -->
      <div *ngIf="isLoading" class="message-wrapper ai-wrapper typing-wrapper">
        <div class="message-avatar ai-avatar">
          <ion-icon name="sparkles"></ion-icon>
        </div>
        <div class="message-bubble ai-bubble typing-bubble">
          <p class="sender-name">
            <ion-icon name="sparkles-outline"></ion-icon>
            Asistente Virtual
          </p>
          <div class="typing-indicator">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
          </div>
        </div>
      </div>

      <!-- Estado vac铆o -->
      <div *ngIf="!timeline?.length && !isLoading" class="empty-state">
        <div class="empty-icon">
          <ion-icon name="chatbubbles-outline"></ion-icon>
        </div>
        <h3>Bienvenido al Asistente Virtual</h3>
        <p>Comienza una conversaci贸n preguntando lo que necesites. Estoy aqu铆 para ayudarte.</p>
        <div class="quick-suggestions">
          <ion-chip class="suggestion-chip">
            <ion-icon name="bulb-outline"></ion-icon>
            <ion-label>驴C贸mo funciona?</ion-label>
          </ion-chip>
          <ion-chip class="suggestion-chip">
            <ion-icon name="help-circle-outline"></ion-icon>
            <ion-label>Necesito ayuda</ion-label>
          </ion-chip>
        </div>
      </div>

    </div>

  </div>
</ion-content>

<ion-footer class="ai-chat-footer">
  <ion-toolbar>
    <form [formGroup]="chatForm" (ngSubmit)="sendMessage()" class="message-form">
      
      <!-- Selector de tipo de respuesta -->
      <div class="response-selector">
        <ion-select 
          [(ngModel)]="responseLength"
          [ngModelOptions]="{standalone: true}"
          interface="popover"
          label="Tipo de respuesta"
          class="response-type-select">
          <ion-select-option *ngFor="let option of responseLengthOptions" [value]="option.value">
            {{ option.label }}
          </ion-select-option>
        </ion-select>
      </div>

      <!-- Composer de mensaje -->
      <div class="message-composer">
        
        <div class="input-wrapper">
          <ion-input 
            formControlName="message"
            placeholder="Escribe un mensaje..."
            type="text"
            class="message-input">
          </ion-input>
        </div>

        <!-- Controles de voz -->
        <div class="voice-controls">
          <ion-button
            fill="clear"
            size="small"
            [disabled]="speechSupported !== true || isLoading"
            (click)="toggleRecording()"
            [color]="isRecording ? 'danger' : 'medium'"
            [class.recording]="isRecording"
            class="voice-btn"
            aria-label="Activar micr贸fono">
            <ion-icon [name]="isRecording ? 'mic' : 'mic-outline'"></ion-icon>
          </ion-button>

          <!-- Indicador de grabaci贸n -->
          <div class="recording-indicator" *ngIf="isRecording">
            <div class="recording-info">
              <span class="recording-dot"></span>
              <span class="recording-label">Grabando</span>
            </div>
          </div>
        </div>

        <!-- Bot贸n de enviar -->
        <ion-button 
          class="send-btn"
          type="submit"
          [disabled]="chatForm.invalid || isLoading">
          <ion-icon name="send" slot="icon-only"></ion-icon>
        </ion-button>
      </div>

      <!-- Alertas de voz -->
      <div class="voice-alerts">
        <ion-note color="danger" *ngIf="recognitionError" class="alert-message">
          {{ recognitionError }}
        </ion-note>
        <ion-note color="medium" *ngIf="speechSupported === false" class="alert-message">
          Tu navegador no admite la captura de voz.
        </ion-note>
      </div>

    </form>
  </ion-toolbar>
</ion-footer>
