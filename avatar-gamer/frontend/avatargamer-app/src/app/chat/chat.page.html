<ion-header class="custom-header">
  <ion-toolbar>
    
    <ion-buttons slot="start">
      <ion-back-button 
        [defaultHref]="userRole === 'operator' ? '/operator' : '/user'" 
        [hidden]="isCallActive"
        class="back-btn">
      </ion-back-button>
    </ion-buttons>
    
    <!-- Header simple cuando no hay contacto -->
    <ion-title *ngIf="!contactName && !isCallActive">
      {{ userRole === 'operator' ? 'Chat con Usuario' : 'Chat con Operador' }}
    </ion-title>
    
    <!-- Header con info de contacto -->
    <div *ngIf="contactName && !isCallActive" class="contact-header">
      <div class="contact-avatar" [class.online]="contactStatus === 'online'">
        <ion-icon [name]="userRole === 'operator' ? 'person' : 'headset'"></ion-icon>
        <span class="status-dot" *ngIf="contactStatus === 'online'"></span>
      </div>
      <div class="contact-info">
        <h2 class="contact-name">{{ contactName }}</h2>
        <span class="contact-status" [class.online]="contactStatus === 'online'">
          <ion-icon [name]="contactStatus === 'online' ? 'radio-button-on' : 'radio-button-off'"></ion-icon>
          {{ contactStatus === 'online' ? 'En línea' : 'Desconectado' }}
        </span>
      </div>
    </div>

    <!-- Header durante llamada -->
    <ion-title *ngIf="isCallActive">
      Videollamada con {{ contactName }}
    </ion-title>

    <ion-buttons slot="end">
      <ion-button *ngIf="!isCallActive" (click)="startVideoCall()" [disabled]="!selectedContact" class="video-btn">
        <ion-icon slot="icon-only" name="videocam-outline"></ion-icon>
      </ion-button>

      <ion-button *ngIf="isCallActive" (click)="onCallEnded()" class="end-call-btn">
        <ion-icon slot="icon-only" name="arrow-undo-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    
  </ion-toolbar>
</ion-header>

<ion-content [class.video-active]="isCallActive" class="chat-content">
  
  <!-- Contenido del chat (oculto durante llamada) -->
  <div [hidden]="isCallActive" class="chat-wrapper">
    
    <!-- Banner de bienvenida -->
    <div class="welcome-banner" *ngIf="userRole && contactName">
      <div class="banner-icon">
        <ion-icon [name]="userRole === 'operator' ? 'chatbubbles' : 'help-circle'"></ion-icon>
      </div>
      <div class="banner-content">
        <h3>{{ userRole === 'operator' ? 'Conversación con ' + contactName : 'Soporte con ' + contactName }}</h3>
        <p *ngIf="userRole === 'operator'">
          Ayuda al usuario con sus consultas. Puedes iniciar videollamada en cualquier momento.
        </p>
        <p *ngIf="userRole !== 'operator'">
          Tu asistente está aquí para ayudarte. Solicita videollamada si necesitas ayuda visual.
        </p>
      </div>
    </div>

    <!-- Banner de estado de conexión -->
    <div *ngIf="(connectionState$ | async) as connectionState" class="connection-status">
      <div *ngIf="connectionState !== 'connected'" class="status-banner" [attr.data-state]="connectionState">
        <ion-icon [name]="connectionState === 'connecting' ? 'cloud-upload-outline' : 'cloud-offline-outline'"></ion-icon>
        <div class="status-text">
          <h4>
            {{ connectionState === 'connecting'
              ? 'Conectando con el servidor...'
              : 'Sin conexión con el servidor' }}
          </h4>
          <p *ngIf="connectionState === 'disconnected'">
            Revisa tu conexión a internet o intenta nuevamente.
          </p>
        </div>
      </div>
    </div>

    <!-- Mensajes del chat -->
    <div class="messages-container" *ngIf="userProfile as profile">
      <div *ngFor="let message of (messages$ | async)" 
           class="message-wrapper"
           [class.outgoing]="message.senderId === profile?.id"
           [class.incoming]="message.senderId !== profile?.id">
        <div class="message-bubble">
          <div class="message-text">{{ message.text }}</div>
          <div class="message-footer">
            <span class="message-sender">
              {{ message.senderId === profile?.id ? 'Tú' : (message.senderRole === 'operator' ? 'Operador' : 'Usuario') }}
            </span>
            <span class="message-time">{{ message.timestamp | date:'shortTime' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Estado vacío -->
    <div class="empty-state" *ngIf="!selectedContact">
      <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
      <h3>Sin conversación activa</h3>
      <p>Selecciona un contacto para iniciar una conversación</p>
    </div>
  </div>

  <!-- Contenedor de videollamada -->
  <div class="video-container" *ngIf="isCallActive">
    <app-jitsi-call
      [roomName]="currentRoomName"
      [displayName]="currentDisplayName"
      [robotId]="robotIdForCall"
      [isOperator]="userRole === 'operator'"
      [showControls]="userRole === 'operator'"
      (callEnded)="onCallEnded()">
    </app-jitsi-call>
  </div>

</ion-content>

<ion-footer [hidden]="isCallActive" class="chat-footer">
  <ion-toolbar>
    <div class="message-composer">
      
      <!-- Botón de respuestas rápidas -->
      <ion-button 
        fill="clear" 
        class="quick-response-btn"
        (click)="showQuickResponses()" 
        [disabled]="!selectedContact">
        <ion-icon slot="icon-only" name="list-outline"></ion-icon>
      </ion-button>

      <!-- Input de mensaje -->
      <div class="input-wrapper">
        <ion-input 
          placeholder="Escribe un mensaje..." 
          [(ngModel)]="newMessage" 
          [disabled]="!selectedContact"
          class="message-input">
        </ion-input>
      </div>

      <!-- Controles de voz -->
      <div class="voice-controls">
        <ion-button
          fill="clear"
          size="small"
          [disabled]="speechSupported !== true || !selectedContact"
          (click)="toggleRecording()"
          [color]="isRecording ? 'danger' : 'medium'"
          [class.recording]="isRecording"
          class="voice-btn"
          aria-label="Activar micrófono">
          <ion-icon [name]="isRecording ? 'mic' : 'mic-outline'"></ion-icon>
        </ion-button>
        
        <!-- Indicador de grabación -->
        <div class="recording-indicator" *ngIf="isRecording">
          <div class="pulse-animation"></div>
          <div class="recording-info">
            <span class="recording-dot"></span>
            <span class="recording-label">Grabando</span>
            <span class="recording-duration">{{ recordingDuration }}</span>
          </div>
        </div>
      </div>

      <!-- Botón de enviar -->
      <ion-button 
        class="send-btn"
        (click)="sendMessage()" 
        [disabled]="!newMessage || !selectedContact">
        <ion-icon name="send" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
    
    <!-- Mensajes de error -->
    <div class="voice-alerts">
      <ion-note color="danger" *ngIf="recognitionError" class="alert-message">
        {{ recognitionError }}
      </ion-note>
      <ion-note color="medium" *ngIf="speechSupported === false" class="alert-message">
        Tu navegador no admite la captura de voz.
      </ion-note>
    </div>
  </ion-toolbar>
</ion-footer>
