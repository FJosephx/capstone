<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>Panel de Operador</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="logout()">
        <ion-icon name="log-out-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-card>
    <ion-card-header>
      <ion-card-title>Bienvenido, {{ userProfile?.username }}</ion-card-title>
      <ion-card-subtitle>Operador</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-item lines="none">
        <ion-icon name="person" slot="start"></ion-icon>
        <ion-label>
          <h2 class="user-id">ID: <span class="id-value">{{ userProfile?.id }}</span></h2>
          <p>Email: {{ userProfile?.email }}</p>
        </ion-label>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <ion-segment [(ngModel)]="activeTab" (ionChange)="segmentChanged($event)" mode="ios" class="ion-margin-bottom">
    <ion-segment-button value="linked">
      <ion-label>Usuarios Vinculados</ion-label>
    </ion-segment-button>
    <ion-segment-button value="pending">
      <ion-label>Solicitudes Enviadas</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Pestaña de usuarios vinculados -->
  <div *ngIf="activeTab === 'linked'">
    <ion-list>
      <ion-list-header>
        <ion-label>Usuarios vinculados</ion-label>
        <ion-button size="small" fill="clear" (click)="openAddContactModal()">
          <ion-icon name="add-circle" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-list-header>
      
      <ion-item *ngFor="let user of linkedUsers" button detail class="linked-user-item" (click)="startChatWithUser(user)">
        <ion-icon [name]="user.status === 'online' ? 'person' : 'person-outline'" 
                  [color]="user.status === 'online' ? 'success' : 'medium'"
                  slot="start"></ion-icon>
        <ion-label>
          <h2 class="user-name">{{ user.username }}</h2>
          <p class="user-email">{{ user.email }}</p>
          <p class="user-status">Status: <span [class]="user.status === 'online' ? 'status-online' : 'status-offline'">{{ user.status }}</span></p>
        </ion-label>
        <ion-button fill="clear" slot="end" (click)="unlinkUser(user); $event.stopPropagation()">
          <ion-icon name="trash" color="danger"></ion-icon>
        </ion-button>
        <ion-icon name="chatbubbles-outline" slot="end" color="primary"></ion-icon>
      </ion-item>
      
      <ion-item *ngIf="isLoading && activeTab === 'linked'" lines="none">
        <ion-label color="medium" class="ion-text-center">
          <ion-spinner name="dots"></ion-spinner>
          <p>Cargando usuarios vinculados...</p>
        </ion-label>
      </ion-item>
      
      <ion-item *ngIf="!isLoading && linkedUsers.length === 0 && activeTab === 'linked'" lines="none">
        <ion-label color="medium" class="ion-text-center">
          <p>No hay usuarios vinculados</p>
          <ion-button expand="block" size="small" (click)="openAddContactModal()">
            Solicitar Vinculación
          </ion-button>
        </ion-label>
      </ion-item>
    </ion-list>
  </div>
  
  <!-- Pestaña de solicitudes enviadas -->
  <div *ngIf="activeTab === 'pending'">
    <ion-list>
      <ion-list-header>
        <ion-label>Solicitudes de Vinculación</ion-label>
        <ion-button size="small" fill="clear" (click)="openAddContactModal()">
          <ion-icon name="add-circle" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-list-header>
      
      <ion-item *ngFor="let request of linkRequests" button detail class="request-item">
        <ion-icon name="person-add-outline" slot="start" color="primary"></ion-icon>
        <ion-label>
          <h2 class="request-username">Usuario: {{ request.user_username }}</h2>
          <p *ngIf="request.message" class="request-message">"{{ request.message }}"</p>
          <p class="request-date">Enviada: {{ request.created_at | date:'medium' }}</p>
        </ion-label>
        <ion-badge slot="end" [color]="getStatusColor(request.status)">
          {{ getStatusText(request.status) }}
        </ion-badge>
      </ion-item>
      
      <ion-item *ngIf="isLoading && activeTab === 'pending'" lines="none">
        <ion-label color="medium" class="ion-text-center">
          <ion-spinner name="dots"></ion-spinner>
          <p>Cargando solicitudes...</p>
        </ion-label>
      </ion-item>
      
      <ion-item *ngIf="!isLoading && linkRequests.length === 0 && activeTab === 'pending'" lines="none">
        <ion-label color="medium" class="ion-text-center">
          <p>No hay solicitudes de vinculación enviadas</p>
          <ion-button expand="block" size="small" (click)="openAddContactModal()">
            Nueva Solicitud
          </ion-button>
        </ion-label>
      </ion-item>
    </ion-list>
  </div>
  
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openAddContactModal()">
      <ion-icon name="person-add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  
  <!-- Botón flotante para chat -->
  <ion-fab vertical="bottom" horizontal="start" slot="fixed">
    <ion-fab-button color="primary" routerLink="/chat" class="chat-button">
      <ion-icon name="chatbubbles"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
