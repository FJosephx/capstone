<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>Panel de Usuario</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="logout()">
        <ion-icon name="log-out-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-card>
    <ion-card-header>
      <ion-card-title>Bienvenido, {{ userProfile?.username }}</ion-card-title>
      <ion-card-subtitle>{{ userProfile?.role === 'user' ? 'Usuario' : userProfile?.role }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-item lines="none">
        <ion-icon name="person" slot="start"></ion-icon>
        <ion-label>
          <h2>ID: {{ userProfile?.id }}</h2>
          <p>Email: {{ userProfile?.email }}</p>
        </ion-label>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <ion-segment [(ngModel)]="activeTab" (ionChange)="segmentChanged($event)" mode="ios" class="ion-margin-bottom">
    <ion-segment-button value="linked">
      <ion-label>Operadores Vinculados</ion-label>
    </ion-segment-button>
    <ion-segment-button value="requests">
      <ion-label>Solicitudes Pendientes</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Pestaña de operadores vinculados -->
  <div *ngIf="activeTab === 'linked'">
    <div class="refresh-container">
      <ion-button fill="clear" size="small" (click)="loadLinkedOperators()" [disabled]="isLoading">
        <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
      </ion-button>
    </div>
    
    <ion-list>
      <ion-list-header>
        <ion-label>Operadores vinculados</ion-label>
      </ion-list-header>
      
      <ion-item *ngFor="let operator of linkedOperators" button detail class="operator-item">
        <ion-avatar slot="start">
          <ion-icon class="avatar-icon" [name]="operator.status === 'online' ? 'person-circle' : 'person-circle-outline'" 
                    [color]="operator.status === 'online' ? 'success' : 'medium'"
                    size="large"></ion-icon>
        </ion-avatar>
        <ion-label>
          <h2>{{ operator.username || 'Operador ' + operator.id }}</h2>
          <h3>{{ operator.first_name || 'Operador' }} {{ operator.last_name || '#' + operator.id }}</h3>
          <p>{{ operator.email || operator.username + '@example.com' }}</p>
          <div class="badge-container">
            <ion-badge [color]="operator.status === 'online' ? 'success' : 'medium'" class="status-badge">
              {{ operator.status === 'online' ? 'En línea' : 'Desconectado' }}
            </ion-badge>
            <ion-badge color="tertiary" class="role-badge">Operador</ion-badge>
          </div>
        </ion-label>
        <ion-icon name="chatbubbles-outline" slot="end" color="primary"></ion-icon>
      </ion-item>
      
      <ion-item *ngIf="isLoading && activeTab === 'linked'" lines="none">
        <ion-label color="medium" class="ion-text-center">
          <ion-spinner name="dots"></ion-spinner>
          <p>Cargando operadores vinculados...</p>
        </ion-label>
      </ion-item>
      
      <ion-item *ngIf="!isLoading && linkedOperators.length === 0 && activeTab === 'linked'" lines="none">
        <ion-label color="medium" class="ion-text-center">
          <p>No tienes operadores vinculados</p>
        </ion-label>
      </ion-item>
    </ion-list>
  </div>
  
  <!-- Pestaña de solicitudes pendientes -->
  <div *ngIf="activeTab === 'requests'">
    <ion-list>
      <ion-list-header>
        <ion-label>Solicitudes de Vinculación</ion-label>
      </ion-list-header>
      
      <ion-item *ngFor="let request of pendingRequests" class="request-item">
        <ion-icon name="person-add-outline" slot="start" color="primary"></ion-icon>
        <ion-label>
          <h2>Operador: {{ request.operator_username || 'Operador #' + request.operator }}</h2>
          <p *ngIf="request.message" class="request-message">"{{ request.message }}"</p>
          <p>Recibida: {{ request.created_at | date:'medium' }}</p>
        </ion-label>
        <div class="action-buttons">
          <ion-button fill="clear" color="success" (click)="respondToRequest(request, 'approved')">
            <ion-icon name="checkmark" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" color="danger" (click)="respondToRequest(request, 'rejected')">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </ion-item>
      
      <ion-item *ngIf="isLoading && activeTab === 'requests'" lines="none">
        <ion-label color="medium" class="ion-text-center">
          <ion-spinner name="dots"></ion-spinner>
          <p>Cargando solicitudes pendientes...</p>
        </ion-label>
      </ion-item>
      
      <ion-item *ngIf="!isLoading && pendingRequests.length === 0 && activeTab === 'requests'" lines="none">
        <ion-label color="medium" class="ion-text-center">
          <p>No tienes solicitudes de vinculación pendientes</p>
        </ion-label>
      </ion-item>
    </ion-list>
  </div>
</ion-content>
